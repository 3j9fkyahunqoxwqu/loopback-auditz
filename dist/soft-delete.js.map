{"version":3,"sources":["soft-delete.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,IAAM,KAAK,GAAG,sBAAQ,CAAC;;kBAER,UAAC,KAAK,QAA4E;4BAAxE,SAAS;MAAT,SAAS,kCAAG,WAAW;6BAAE,UAAU;;MAAV,UAAU,mCAAG,YAAY;;wBAAE,KAAK;MAAL,KAAK,8BAAG,KAAK;;AACxF,OAAK,CAAC,+BAA+B,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;;AAExD,OAAK,CAAC,SAAS,EAAE,EAAE,SAAS,EAAT,SAAS,EAAE,UAAU,EAAV,UAAU,EAAE,KAAK,EAAL,KAAK,EAAE,CAAC,CAAC;;AAEnD,MAAM,UAAU,GAAG,KAAK,CAAC,UAAU,CAAC,UAAU,CAAC;AAC/C,MAAM,QAAQ,GAAG,KAAK,GACpB,oBAAY,UAAU,CAAC,CACpB,MAAM,CAAC,UAAA,IAAI;WAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,IAAI,KAAK,UAAU;GAAA,CAAC,CAC3D,MAAM,CAAC,UAAC,GAAG,EAAE,IAAI;sCAAW,GAAG,oCAAG,IAAI,EAAG,IAAI;GAAG,EAAE,EAAE,CAAC,GACtD,EAAE,CAAC;;AAEP,OAAK,CAAC,cAAc,CAAC,SAAS,EAAE,EAAC,IAAI,EAAE,IAAI,EAAE,QAAQ,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAC,CAAC,CAAC;AACnF,OAAK,CAAC,cAAc,CAAC,UAAU,EAAE,EAAC,IAAI,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAI,EAAE,OAAO,EAAE,KAAK,EAAC,CAAC,CAAC;;AAElF,OAAK,CAAC,UAAU,GAAG,SAAS,cAAc,CAAC,KAAK,EAAE,EAAE,EAAE;;;AACpD,QAAM,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC;AACxC,SAAK,CAAC,YAAY,GAAG,YAAM,EAAE,CAAC;;AAE9B,WAAO,KAAK,CAAC,SAAS,CAAC,KAAK,6BAAO,QAAQ,4DAAG,SAAS,EAAG,IAAI,IAAI,EAAE,4CAAG,UAAU,EAAG,IAAI,eAAG,CAAC,IAAI,CAAC,UAAA,MAAM,EAAI;AACzG,WAAK,CAAC,YAAY,GAAG,YAAY,CAAC;AAClC,UAAI,EAAE,EAAE,OAAO,EAAE,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AAChC,aAAO,kBAAQ,OAAO,CAAC,MAAM,CAAC,CAAC;KAChC,CAAC,CAAC,KAAK,CAAC,UAAA,KAAK;aAAI,EAAE,CAAC,KAAK,CAAC;KAAA,CAAC,CAAC;GAC9B,CAAC;;AAEF,OAAK,CAAC,MAAM,GAAG,KAAK,CAAC,UAAU,CAAC;AAChC,OAAK,CAAC,SAAS,GAAG,KAAK,CAAC,UAAU,CAAC;;AAEnC,OAAK,CAAC,WAAW,GAAG,SAAS,eAAe,CAAC,EAAE,EAAE,EAAE,EAAE;;;AACnD,QAAM,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC;AACxC,SAAK,CAAC,YAAY,GAAG,YAAM,EAAE,CAAC;;AAE9B,WAAO,KAAK,CAAC,SAAS,CAAC,EAAE,EAAE,EAAE,EAAE,EAAE,6BAAO,QAAQ,4DAAG,SAAS,EAAG,IAAI,IAAI,EAAE,4CAAG,UAAU,EAAG,IAAI,eAAG,CAAC,IAAI,CAAC,UAAA,MAAM,EAAI;AAC9G,WAAK,CAAC,YAAY,GAAG,YAAY,CAAC;AAClC,UAAI,EAAE,EAAE,OAAO,EAAE,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AAChC,aAAO,kBAAQ,OAAO,CAAC,MAAM,CAAC,CAAC;KAChC,CAAC,CAAC,KAAK,CAAC,UAAA,KAAK;aAAI,EAAE,CAAC,KAAK,CAAC;KAAA,CAAC,CAAC;GAC9B,CAAC;;AAEF,OAAK,CAAC,UAAU,GAAG,KAAK,CAAC,WAAW,CAAC;AACrC,OAAK,CAAC,UAAU,GAAG,KAAK,CAAC,WAAW,CAAC;;AAErC,OAAK,CAAC,SAAS,CAAC,OAAO,GAAG,SAAS,WAAW,CAAC,EAAE,EAAE;;;AACjD,QAAM,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC;AACxC,SAAK,CAAC,YAAY,GAAG,YAAM,EAAE,CAAC;;AAE9B,WAAO,IAAI,CAAC,gBAAgB,4BAAM,QAAQ,4DAAG,SAAS,EAAG,IAAI,IAAI,EAAE,4CAAG,UAAU,EAAG,IAAI,eAAG,CAAC,IAAI,CAAC,UAAA,MAAM,EAAI;AACxG,WAAK,CAAC,YAAY,GAAG,YAAY,CAAC;AAClC,UAAI,EAAE,EAAE,OAAO,EAAE,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;AAChC,aAAO,kBAAQ,OAAO,CAAC,MAAM,CAAC,CAAC;KAChC,CAAC,CAAC,KAAK,CAAC,UAAA,KAAK;aAAI,EAAE,CAAC,KAAK,CAAC;KAAA,CAAC,CAAC;GAC9B,CAAC;;AAEF,OAAK,CAAC,SAAS,CAAC,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,OAAO,CAAC;AACjD,OAAK,CAAC,SAAS,CAAC,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,OAAO;;;AAAC,AAGjD,MAAM,aAAa,GAAG,KAAK,CAAC,YAAY,CAAC;AACzC,OAAK,CAAC,YAAY,GAAG,SAAS,mBAAmB,GAAsB;QAArB,KAAK,yDAAG,EAAE;;AAC1D,QAAI,CAAC,KAAK,CAAC,KAAK,EAAE,KAAK,CAAC,KAAK,GAAG,EAAE,CAAC;;AAEnC,QAAI,CAAC,KAAK,CAAC,OAAO,EAAE;AAClB,WAAK,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,KAAK,CAAC;KACjC;;sCAL8D,IAAI;AAAJ,UAAI;;;AAOnE,WAAO,aAAa,CAAC,IAAI,MAAA,CAAlB,aAAa,GAAM,KAAK,EAAE,KAAK,SAAK,IAAI,EAAC,CAAC;GAClD,CAAC;;AAEF,MAAM,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC;AACzB,OAAK,CAAC,IAAI,GAAG,SAAS,WAAW,GAAsB;QAArB,KAAK,yDAAG,EAAE;;AAC1C,QAAI,CAAC,KAAK,CAAC,KAAK,EAAE,KAAK,CAAC,KAAK,GAAG,EAAE,CAAC;;AAEnC,QAAI,CAAC,KAAK,CAAC,OAAO,EAAE;AAClB,WAAK,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,KAAK,CAAC;KACjC;;uCAL8C,IAAI;AAAJ,UAAI;;;AAOnD,WAAO,KAAK,CAAC,IAAI,MAAA,CAAV,KAAK,GAAM,KAAK,EAAE,KAAK,SAAK,IAAI,EAAC,CAAC;GAC1C,CAAC;;AAEF,MAAM,MAAM,GAAG,KAAK,CAAC,KAAK,CAAC;AAC3B,OAAK,CAAC,KAAK,GAAG,SAAS,YAAY,GAAsB;QAArB,KAAK,yDAAG,EAAE;;;AAE5C,SAAK,CAAC,UAAU,CAAC,GAAG,KAAK,CAAC;;uCAFuB,IAAI;AAAJ,UAAI;;;AAGrD,WAAO,MAAM,CAAC,IAAI,MAAA,CAAX,MAAM,GAAM,KAAK,EAAE,KAAK,SAAK,IAAI,EAAC,CAAC;GAC3C,CAAC;;AAEF,MAAM,OAAO,GAAG,KAAK,CAAC,MAAM,CAAC;AAC7B,OAAK,CAAC,MAAM,GAAG,KAAK,CAAC,SAAS,GAAG,SAAS,aAAa,GAAsB;QAArB,KAAK,yDAAG,EAAE;;;AAEhE,SAAK,CAAC,UAAU,CAAC,GAAG,KAAK,CAAC;;uCAF2C,IAAI;AAAJ,UAAI;;;AAGzE,WAAO,OAAO,CAAC,IAAI,MAAA,CAAZ,OAAO,GAAM,KAAK,EAAE,KAAK,SAAK,IAAI,EAAC,CAAC;GAC5C,CAAC;CACH","file":"soft-delete.js","sourcesContent":["import _debug from './debug';\nconst debug = _debug();\n\nexport default (Model, { deletedAt = 'deletedAt', _isDeleted = '_isDeleted', scrub = false }) => {\n  debug('SoftDelete mixin for Model %s', Model.modelName);\n\n  debug('options', { deletedAt, _isDeleted, scrub });\n\n  const properties = Model.definition.properties;\n  const scrubbed = scrub ?\n    Object.keys(properties)\n      .filter(prop => !properties[prop].id && prop !== _isDeleted)\n      .reduce((obj, prop) => ({ ...obj, [prop]: null }), {})\n    : {};\n\n  Model.defineProperty(deletedAt, {type: Date, required: false, default: undefined});\n  Model.defineProperty(_isDeleted, {type: Boolean, required: true, default: false});\n\n  Model.destroyAll = function softDestroyAll(where, cb) {\n    const defaultScope = Model.defaultScope;\n    Model.defaultScope = () => {};\n\n    return Model.updateAll(where, { ...scrubbed, [deletedAt]: new Date(), [_isDeleted]: true }).then(result => {\n      Model.defaultScope = defaultScope;\n      if (cb) return cb(null, result);\n      return Promise.resolve(result);\n    }).catch(error => cb(error));\n  };\n\n  Model.remove = Model.destroyAll;\n  Model.deleteAll = Model.destroyAll;\n\n  Model.destroyById = function softDestroyById(id, cb) {\n    const defaultScope = Model.defaultScope;\n    Model.defaultScope = () => {};\n\n    return Model.updateAll({ id: id }, { ...scrubbed, [deletedAt]: new Date(), [_isDeleted]: true }).then(result => {\n      Model.defaultScope = defaultScope;\n      if (cb) return cb(null, result);\n      return Promise.resolve(result);\n    }).catch(error => cb(error));\n  };\n\n  Model.removeById = Model.destroyById;\n  Model.deleteById = Model.destroyById;\n\n  Model.prototype.destroy = function softDestroy(cb) {\n    const defaultScope = Model.defaultScope;\n    Model.defaultScope = () => {};\n\n    return this.updateAttributes({ ...scrubbed, [deletedAt]: new Date(), [_isDeleted]: true }).then(result => {\n      Model.defaultScope = defaultScope;\n      if (cb) return cb(null, result);\n      return Promise.resolve(result);\n    }).catch(error => cb(error));\n  };\n\n  Model.prototype.remove = Model.prototype.destroy;\n  Model.prototype.delete = Model.prototype.destroy;\n\n  // Emulate default scope but with more flexibility.\n  const _findOrCreate = Model.findOrCreate;\n  Model.findOrCreate = function findOrCreateDeleted(query = {}, ...rest) {\n    if (!query.where) query.where = {};\n\n    if (!query.deleted) {\n      query.where[_isDeleted] = false;\n    }\n\n    return _findOrCreate.call(Model, query, ...rest);\n  };\n\n  const _find = Model.find;\n  Model.find = function findDeleted(query = {}, ...rest) {\n    if (!query.where) query.where = {};\n\n    if (!query.deleted) {\n      query.where[_isDeleted] = false;\n    }\n\n    return _find.call(Model, query, ...rest);\n  };\n\n  const _count = Model.count;\n  Model.count = function countDeleted(where = {}, ...rest) {\n    // Because count only receives a 'where', there's nowhere to ask for the deleted entities.\n    where[_isDeleted] = false;\n    return _count.call(Model, where, ...rest);\n  };\n\n  const _update = Model.update;\n  Model.update = Model.updateAll = function updateDeleted(where = {}, ...rest) {\n    // Because update/updateAll only receives a 'where', there's nowhere to ask for the deleted entities.\n    where[_isDeleted] = false;\n    return _update.call(Model, where, ...rest);\n  };\n};\n"],"sourceRoot":"/Users/gausie/Projects/loopback-ds-timestamp-mixin/es6"}